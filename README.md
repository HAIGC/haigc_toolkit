# HAIGC Toolkit for ComfyUI

<div align="center">

[中文](README.md) | [English](README_EN.md)

[![Version](https://img.shields.io/badge/version-3.3.8-blue.svg)](version.py)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)
[![ComfyUI](https://img.shields.io/badge/ComfyUI-Compatible-orange.svg)](https://github.com/comfyanonymous/ComfyUI)
[![Python](https://img.shields.io/badge/python-3.8+-brightgreen.svg)](https://www.python.org/)

**🎬 ComfyUI专业视频和图片处理工具集**

专注于字幕处理和视频拼接的强大节点集合

[特性](#-特色功能) • [安装](#-安装) • [使用指南](#-使用指南) • [节点介绍](#-节点列表) • [更新日志](#-更新日志)

</div>

---

## 📦 节点列表

### 🎬 字幕节点

#### 1️⃣ 视频字幕增强版 (VideoSubtitleEnhanced) v2.5.0
**适合**：单段字幕，需要丰富样式和创意效果

**核心特性**：
- ✨ **横竖排版** - 完美支持中日韩竖排文字
- ✨ **字体角度** - 0-360度自由旋转
- ✨ **多种渐变** - 线性、径向、对角渐变
- ✨ **描边位置** - 外部/居中/内部三种模式
- ✨ **投影效果** - 角度、距离、强度、模糊全控制
- ✨ **28种动画** - 从基础到高级的丰富特效
- ✨ **位置预设** - 12种常用位置一键选择
- ✨ **字间距调整** - -50 到 +200px 精细调节
- ✨ **字体粗细** - 常规/粗体/特粗/超粗 4级

**适用场景**：
- 标题字幕
- 创意文字展示
- 竖排诗词
- 旋转特效字幕

---

#### 2️⃣ 视频字幕时间戳专业版 (VideoSubtitleTimestampPro) v2.7.0
**适合**：多段字幕，需要时间轴管理

**核心特性**：
- ✨ **4种格式** - SRT/简单/括号/无时间戳
  - **SRT格式**：`00:00:01,000 --> 00:00:02,000`
  - **简单格式**：`0.0-0.26 文本`
  - **括号格式**：`(0.0, 0.26) 文本` ⭐新增
  - **无时间戳**：自动计算时间
- ✨ **符号去除** - 5种模式智能处理 ⭐新增
  - 不去除/中文标点/英文标点/所有标点/所有符号
- ✨ **滚动字幕** - 完美的片尾滚动效果
- ✨ **32种动画** - 比增强版更多的动效选择
- ✨ **字体粗细** - 4级粗细选择
- ✨ **投影系统** - 完整的投影参数控制
- ✨ **渐变色** - 2-3色渐变，3种方向
- ✨ **位置预设** - 12种位置快速选择
- ✨ **画布约束** - 自动缩放/按字裁剪

**适用场景**：
- 视频配字幕
- SRT字幕导入
- 多段对话字幕
- 片尾滚动字幕

---

### 🎞️ 视频处理节点

#### 3️⃣ 视频拼接过渡 (VideoTransition) v3.2.1
**26种专业过渡效果，让视频拼接更流畅**

**基础过渡**：
- 🔀 直接拼接 - 无过渡，直接拼接
- 🌅 交叉淡化 - 经典淡入淡出
- ↔️ 推移效果 - 左/右/上/下 4个方向
- 🔍 缩放过渡 - 放大/缩小

**渐变擦除** (4方向)：
- ⬅️ 从左到右
- ➡️ 从右到左
- ⬆️ 从上到下
- ⬇️ 从下到上

**扩散效果** (2种)：
- ⭕ 圆形扩散
- ⬜ 方形扩散

**创意效果**：
- 🎯 百叶窗 - 水平/垂直
- ♟️ 棋盘格过渡
- 📐 对角线擦除 - 左上/右下
- 🌊 波纹效果
- 🕐 时钟擦除
- 🎨 马赛克过渡
- 📖 翻页效果 - 左翻/右翻

**特点**：
- ⚡ GPU加速处理
- 🎬 专业级过渡质量
- 🔧 简单易用
- 📊 支持大分辨率视频

---

#### 4️⃣ 获取视频尾帧 (VideoLastFrame) v1.0.0
**功能**：
- 提取视频最后N帧
- 灵活的帧数控制
- 快速预览视频结尾

---

### 🖼️ 图片处理节点

#### 5️⃣ 图片批次累积 (ImageAccumulator) v1.0.0
**功能**：
- 智能批次图片累积
- 自动批处理管理
- 优化工作流程

---

## 🚀 安装

### 方法1：ComfyUI Manager（推荐）
1. 打开 ComfyUI Manager
2. 搜索 `HAIGC Toolkit`
3. 点击安装
4. 重启 ComfyUI

### 方法2：手动安装
```bash
cd ComfyUI/custom_nodes/
git clone https://github.com/your-repo/haigc_toolkit.git
cd haigc_toolkit
pip install -r requirements.txt
```

### 方法3：一键安装脚本（Windows）
```powershell
# 下载并运行安装脚本
# install.bat
```

---

## 📋 依赖要求

```
numpy>=1.24.0
pillow>=10.0.0
```

ComfyUI 会自动安装这些依赖。

---

## 📖 使用指南

### 🎯 字幕节点选择指南

| 需求 | 推荐节点 | 原因 |
|------|---------|------|
| 单段字幕 | 增强版 | 操作简单，样式丰富 |
| 多段字幕 | 专业版 | 时间轴管理，批量处理 |
| 竖排文字 | 增强版 | 完美的竖排支持 |
| SRT导入 | 专业版 | 原生SRT支持 |
| 滚动字幕 | 专业版 | 专用滚动模式 |
| 创意标题 | 增强版 | 旋转、渐变更灵活 |
| 对话字幕 | 专业版 | 时间戳精确控制 |

### 🔄 两个字幕节点的参数对齐

两个字幕节点的相同功能参数位置已对齐，方便无缝切换：

**共同参数**：
- 📝 **字体样式** - 字体、大小、粗细、颜色、不透明度
- 🖊️ **描边设置** - 大小、颜色、位置、不透明度
- 🌟 **投影设置** - 角度、距离、强度、模糊
- 📍 **位置对齐** - 预设位置、对齐方式、X/Y百分比
- 🎬 **动画效果** - 特效类型、强度、时长

---

## 📝 字幕格式详解

### 1️⃣ SRT格式（标准字幕格式）

```srt
1
00:00:01,000 --> 00:00:02,000
你转身时的风

2
00:00:04,000 --> 00:00:05,000
落叶躺在地上

3
00:00:06,000 --> 00:00:08,000
微风扶起
```

**格式说明**：
- 第1行：序号
- 第2行：时间戳（HH:MM:SS,mmm --> HH:MM:SS,mmm）
- 第3行：字幕文本
- 空行分隔每段字幕

---

### 2️⃣ 简单格式（快速输入）

```
0.0-0.26 大雄，
0.3-1.4 我来参加投稿了，
1.5-2.26 快告诉我，
2.32-2.94 第一名是我。
```

**格式说明**：
- `开始时间-结束时间 文本`
- 时间单位：秒
- 支持小数

---

### 3️⃣ 括号格式（新格式）⭐

```
(0.0, 0.26) 大雄，
(0.3, 1.4) 我来参加投稿了，
(1.5, 2.26) 快告诉我，
(2.32, 2.94) 第一名是我。
```

**格式说明**：
- `(开始时间, 结束时间) 文本`
- 时间单位：秒
- 支持整数和小数
- **默认格式**，最简洁直观

---

### 4️⃣ 无时间戳格式

```
大雄，
我来参加投稿了，
快告诉我，
第一名是我。
```

**设置参数**：
- 开始时间：0秒
- 每段显示时长：2秒
- 字幕间隔：0.5秒

**自动计算**：
- 第1段：0.0-2.0秒
- 第2段：2.5-4.5秒
- 第3段：5.0-7.0秒
- 以此类推...

---

## 🎨 特色功能详解

### ⭐ 符号去除（v2.7.0新增）

**5种去除模式**：

| 模式 | 说明 | 示例 |
|------|------|------|
| **不去除** | 保持原样 | `大雄，我来了！` |
| **中文标点** | 去除，。！？等 | `大雄我来了` |
| **英文标点** | 去除,.!?等 | `Hello world` |
| **所有标点** | 去除所有标点 | `大雄我来了HelloWorld` |
| **所有符号** | 只保留文字数字 | `大雄我来了2023` |

**应用场景**：
- 🎨 简洁字幕 - 去除标点更清爽
- 📱 小屏显示 - 节省空间
- 🌍 多语言处理 - 统一标点格式
- 🎭 艺术字幕 - 纯文字展示

---

### 🎭 字体粗细（4级控制）

| 级别 | 效果 | 适用场景 |
|------|------|----------|
| **常规** | 标准粗细 | 正文字幕 |
| **粗体** | 适中加粗 | 强调字幕 |
| **特粗** | 明显加粗 | 标题字幕 |
| **超粗** | 最大加粗 | 海报字幕 |

**特点**：
- ✅ 支持横排和竖排
- ✅ 支持渐变和描边
- ✅ 智能边距调整

---

### 🌟 投影效果（专业级）

**4大参数**：
- **投影角度**：0-360度，控制投影方向
- **投影距离**：0-100像素，控制偏移量
- **投影强度**：0.0-1.0，控制不透明度
- **投影模糊**：0-30像素，控制边缘模糊

**预设方案**：
- 📺 **右下投影**：角度135°，距离5，强度0.75，模糊4
- 🎬 **底部投影**：角度180°，距离8，强度0.6，模糊5
- ✨ **柔和投影**：角度135°，距离3，强度0.5，模糊8

---

### 📍 位置预设（12种）

| 预设 | X% | Y% | 说明 |
|------|----|----|------|
| 底部居中 | 50 | 85 | 默认字幕位置 |
| 顶部居中 | 50 | 15 | 顶部字幕 |
| 正中央 | 50 | 50 | 屏幕中心 |
| 左下角 | 15 | 85 | 左下位置 |
| 右下角 | 85 | 85 | 右下位置 |
| 左上角 | 15 | 15 | 左上位置 |
| 右上角 | 85 | 15 | 右上位置 |
| 左侧居中 | 15 | 50 | 左侧中间 |
| 右侧居中 | 85 | 50 | 右侧中间 |
| 底部三分之一 | 50 | 75 | 下三分之一 |
| 顶部三分之一 | 50 | 25 | 上三分之一 |
| 自定义 | - | - | 手动设置 |

---

### 📐 对齐方式（3种）

```
┌─────────────────┐
│  左对齐          │  文字从X位置向右延伸
│         居中对齐 │  文字以X位置为中心
│          右对齐 │  文字从X位置向左延伸
└─────────────────┘
```

**组合使用**：
- 左对齐 + X=10% = 文字从左侧开始
- 居中对齐 + X=50% = 文字居中显示
- 右对齐 + X=90% = 文字从右侧开始

---

### 🖼️ 画布约束（3种模式）

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| **否** | 允许超出画布 | 正常字幕 |
| **自动缩放** | 自动缩小字号 | 长文字幕 |
| **按字裁剪** | 按字符裁剪 | 滚动字幕 |

**按字裁剪详解**：
- 🔍 智能识别每个字符边界
- ✂️ 超出的字符整个不显示
- ✅ 未超出的字符完整保留
- 🎬 完美支持滚动字幕和跑马灯效果

---

### 🎬 动画特效

#### 增强版（28种）
**基础**：淡入、淡出、滚动上升、滚动下降、打字机、缩放出现

**飞入**：左飞入、右飞入、上飞入、下飞入

**弹跳**：弹跳出现、旋转淡入、波浪效果、闪烁、抖动出现

**高级**：渐进放大、分裂合并、弹性进入、3D翻转

**增强**：爆炸进入、螺旋出现、粒子聚合、光速飞入、弹簧抖动、翻书效果、液体流动、闪电出现、碎片重组

#### 专业版（32种）
包含增强版所有特效，额外新增：
- 呼吸效果
- 心跳效果
- 震荡波
- 扭曲出现
- 虚化聚焦
- 彩虹渐变
- **滚动字幕**（片尾专用）

---

## ⚡ 性能优化

### GPU优化
- ✅ 自动GPU显存管理
- ✅ 批量处理内存优化
- ✅ 定期显存清理（每100帧）
- ✅ CPU/GPU智能调度

### 字体缓存
- ✅ LRU字体缓存机制
- ✅ 缓存大小：20个字体
- ✅ 自动缓存清理
- ✅ 降低重复IO操作

### 渐变优化
- ✅ NumPy向量化计算
- ✅ 性能提升10-100倍
- ✅ 渐变缓存系统
- ✅ 智能描边算法

### 资源管理
- ✅ 显式清理PIL对象
- ✅ 每50帧强制gc.collect()
- ✅ Windows资源耗尽修复
- ✅ 支持长视频处理

---

## 💡 使用技巧

### 🎯 字幕定位技巧
1. **底部字幕**：位置预设选"底部居中"
2. **顶部字幕**：位置预设选"顶部居中"
3. **画中画字幕**：自定义 X/Y 精确定位
4. **双语字幕**：两个节点叠加，调整Y位置

### 🎨 样式搭配建议
**清晰易读**：
- 字体：白色 + 黑色描边（3-5px）
- 投影：135° + 5px + 0.75强度

**创意标题**：
- 渐变：三色渐变 + 对角方向
- 动画：爆炸进入 + 1.5倍强度

**复古风格**：
- 字体粗细：特粗或超粗
- 颜色：黄色 #FFD700
- 投影：强投影效果

### ⚙️ 性能优化建议
1. **长视频处理**：
   - 启用自动缩放减少计算量
   - 定期重启ComfyUI释放内存

2. **大量字幕**：
   - 使用SRT格式批量导入
   - 减少渐变色数量

3. **高清视频**：
   - 适当降低字号
   - 减少动画强度

---

## ❓ 常见问题

<details>
<summary><b>Q1: 字体显示为方块或乱码？</b></summary>

**解决方案**：
1. 确保字体文件在 `font/` 文件夹中
2. 字体文件格式：`.ttf`, `.otf`, `.ttc`
3. 字体名称不含扩展名
4. 默认字体：`AlibabaHealthFont2.0CN-45R`

</details>

<details>
<summary><b>Q2: 字幕超出画面怎么办？</b></summary>

**解决方案**：
- 方案1：启用"自动缩放"，自动调整字号
- 方案2：手动减小字体大小
- 方案3：使用"按字裁剪"模式

</details>

<details>
<summary><b>Q3: 处理长视频时内存不足？</b></summary>

**解决方案**：
1. 每100帧自动清理显存（已内置）
2. 减少渐变色数量（从3色降到2色）
3. 降低字体缓存大小
4. 分段处理长视频

</details>

<details>
<summary><b>Q4: SRT字幕时间不准确？</b></summary>

**检查项**：
1. 视频帧率设置是否正确（默认30fps）
2. SRT时间戳格式：`00:00:01,000`（逗号分隔毫秒）
3. 时间戳箭头：`-->`（两个减号）

</details>

<details>
<summary><b>Q5: 如何去除字幕中的标点符号？</b></summary>

**操作步骤**：
1. 使用"视频字幕时间戳专业版"节点
2. 在"⚙️ 高级设置"中找到"去除符号"
3. 选择合适的模式：
   - 所有标点：去除所有中英文标点
   - 所有符号：只保留文字和数字

</details>

<details>
<summary><b>Q6: 括号格式和简单格式有什么区别？</b></summary>

**区别**：
- **括号格式**：`(0.0, 0.26) 文本` - 用括号和逗号
- **简单格式**：`0.0-0.26 文本` - 用减号

两种格式功能完全相同，选择你喜欢的即可。

</details>

---

## 🔄 更新日志

### v3.3.8 (2025-11-02) 当前版本
- 🧹 清理：删除过时和无用的文件
- ✅ 删除7个过时的markdown文档
- ✅ 精简requirements.txt
- 📝 新增：创建简洁的README.md使用指南
- 🎯 优化：项目结构更清爽

### v2.7.0 - 字幕时间戳专业版 (2025-11-03)
- ✨ 新增：符号去除功能（5种模式）
- 📝 模式：不去除/中文标点/英文标点/所有标点/所有符号
- 🎯 应用：自动处理所有字幕段和滚动字幕
- 🧠 智能：保留中文、字母、数字、空格

### v2.6.2 - 字幕时间戳专业版 (2025-11-03)
- ✨ 新增：括号格式支持 `(时间1, 时间2) 文本`
- 📝 示例：`(0.0, 0.26) 大雄，`
- 🎯 默认：字幕格式改为"括号格式"

### v2.5.0 - 字幕增强版 (2025-11-02)
- 🎯 对齐：与专业版参数顺序保持一致
- 📐 优化：相同功能模块位置统一
- ✅ 改进：便于在两个节点间切换

### v3.3.5 (2025-11-02)
- 🐛 修复：Windows系统资源耗尽错误
- 🔧 优化：显式清理PIL对象
- 💪 稳定性：大幅提升处理大量帧时的稳定性

### v3.2.0 (2025-11-02)
- 🧹 简化：移除所有颜色匹配功能
- ✅ 改进：视频拼接保持原色
- 📦 优化：代码结构更清晰

[查看完整更新历史](version.py)

---

## 🤝 贡献

欢迎提交Issue和Pull Request！

**贡献指南**：
1. Fork 本仓库
2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
4. 推送到分支 (`git push origin feature/AmazingFeature`)
5. 开启 Pull Request

---

## 📄 许可证

本项目采用 MIT 许可证 - 详见 [LICENSE](LICENSE) 文件

---

## 📧 联系方式

- 💬 **问题反馈**：请在 GitHub 提交 Issue
- 💡 **功能建议**：欢迎在 Issue 中讨论
- 📮 **邮件联系**：[your-email@example.com]

---

## ⭐ Star历史

[![Star History Chart](https://api.star-history.com/svg?repos=your-username/haigc_toolkit&type=Date)](https://star-history.com/#your-username/haigc_toolkit&Date)

---

## 💖 支持作者

如果这个项目对你有帮助，欢迎打赏支持！你的支持是我持续更新的动力 🚀

<div align="center">

### 扫码打赏 - 微信 / 支付宝

<img src="./images/payment_qr.png" alt="打赏二维码" width="600"/>

**感谢您的支持！❤️**

您的赞赏将用于：
- 🔧 持续维护和更新
- ✨ 开发更多实用功能
- 📚 完善文档和教程
- 🐛 快速修复Bug

</div>

---

<div align="center">

**HAIGC Toolkit** - 让 ComfyUI 的视频字幕处理更专业 🎬

---

### 🌟 推荐工作流云平台 | Recommended Cloud Platform

#### 🇨🇳 中文网站 | Chinese Website
**ComfyUI 工作流云平台推荐，点击链接注册领取 1000 算力积分**  
**ComfyUI Workflow Cloud Platform - Register to Get 1000 Computing Points**

👉 [立即注册 | Register Now](https://www.runninghub.cn/user-center/1887871050510716930/userPost?inviteCode=rh-v1127)

#### 🌍 国际网站 | International Website
**国际版云平台，点击链接注册领取 1000 算力积分**  
**International Cloud Platform - Register to Get 1000 Computing Points**

👉 [Register Now | 立即注册](https://www.runninghub.ai/user-center/1939305513756864513/userPost?inviteCode=rh-v1127)

---

Made with ❤️ by HAIGC Team

[⬆ 返回顶部](#haigc-toolkit-for-comfyui)

</div>
